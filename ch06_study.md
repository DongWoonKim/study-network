# ch_06 라우팅

### 외부 네트워크로 데이터를 보낸다

> 이더넷과 무선 LAN으로 같은 네트워크 안에서 데이터를 전송할 수 있다. 하지만 다른 네트워크에 데이터를 보내려면 네트워크를 서로 연결하는 라우터로 전송해야 한다.
>
> 라우터는 데이터의 목적지가 어느 네트워크에 접속해 있는지 판단해서 연결된 네트워크의 라우터로 전송한다.(<strong>라우팅</strong>) 라우팅을 계속 반복하면, 가령 멀리 떨어진 네트워크라도 데이터를 목적지까지 보낼 수 있다.



##### 운반하는 데이터는 IP패킷

> 라우터가 전송할 대상이 되는 데이터는 IP패킷이다. IP패킷은 TCP/IP계층에서는 인터넷층에 속한다. 따라서, 라우팅 동작은 인터넷층에서 하게된다.
>
> 라우터가 IP패킷을 전송할 때는 IP 헤더 안에 있는 목적지 IP주소를 확인한다. IP헤더의 <strong>TTL</strong>과 <strong>헤더 체크섬</strong>만 변경되며, 나머지 부분은 변경되지 않은 채로 전송된다.
>
> 하지만 이더넷 헤더 등 네트워크 인터페이스층 프로토콜의 헤더는 라우터가 전송할 때 완전히 새로운 헤더로 교체된다.



### 라우터에서 네트워크 연결에 필요한 주소 설정

##### IP주소를 설정해서 네트워크를 연결한다

> 라우터로 복수의 네트워크를 연결할 때도 IP주소를 설정한다. 라우터로 네트워크를 서로 연결하기 위해서는 라우터 인터페이스의 물리적 배선에 더해 IP 주소를 설정할 필요가 있다. 
>
> 라우터에는 복수의 인터페이스가 준비되어 있으므로, 물리적인 배선과 IP주소 설정을 각각 할 필요가 있다.



### 라우팅 테이블 : 라우터가 인식하는 네트워크 정보

##### 라우팅 테이블이란?

> 라우팅 테이블에는 어떤 네트워크로 IP패킷을 전송하기 위한 경로가 등록되어 있다. 경로란 구체적으로 다음에 전송해야 하는 라우터이다. 라우팅 테이블에 등록된 네트워크 정보를 <strong>루트 정보</strong>나 <strong>경로 정보</strong>라고 부른다.

##### 이웃 라우터까지 알고 있으면 된다

> 라우터는 라우팅 테이블로 이웃 라우터의 네트워크 구성을 인식한다. 단, 네트워크 전체의 자세한 구성이 아니라, 자신을 중심으로 이웃 라우터 저 너머에 어떤 네트워크가 있는가 하는 수준이다.
>
> 라우팅 테이블 상에서 인식할 수 없는 네트워크로 가는 IP패킷은 모두 폐기된다.



### 직접 접속 : 라우팅 테이블의 가장 기본적인 정보

##### 라우팅 테이블을 만드는 방법

> - 직접 접속
> - 스태틱 라우팅
> - 라우팅 프로토콜

##### 가장 기본은 직접 접속

> <strong>직접 접속</strong>의 경로 정보는 가장 기본적인 경로 정보이다. 라우터에는 네트워크를 연결하는 역할이 있다. 직접 접속의 경로 정보는 이름 그대로 라우터가 직접 연결된 네트워크의 경로 정보이다. 라우터는 직접 접속된 네트워크밖에 모른다.



### 스택틱 라우팅, 라우팅 프로토콜 : 직접 접속되지 않은 경로 정보를 등록하는 방법

##### 원격 네트워크의 경로 정보 등록

> 직접 접속 경로 정보에 더해, 그 라우터에 직접 접속되지 않은 원격 네트워크의 경로 정보를 등록해야 한다.

##### 커맨드를 입력한다

> <strong>스태틱 라우팅</strong>은 라우터에 커맨드를 입력하는 등 경로 정보를 수동으로 라우팅 테이블에 등록하는 방법이다.
>
> 커맨드는 제조사마다 다르지만, 네트워크 주소/서브넷 마스크와 넥스트 홉 주소를 커맨드로 입력하여 라우팅 테이블에 등록한다.
>
> <img src="https://ifh.cc/g/DE7RlN.jpg" alt="l3-switch" style="zoom:30%;" />



##### 라우터끼리 정보를 교환시킨다

> 라우터에서 라우팅 프로토콜을 활성화하면, 라우터끼리 정보를 교환해 라우팅 테이블에 필요한 경로 정보를 등록해준다.
>
> |               이름                |                     개요                     |
> | :-------------------------------: | :------------------------------------------: |
> | RIP(Routing Information Protocol) |      주로 소규모 네트워크에서 이용한다.      |
> |  OSPF(Open Shortest Path First)   | 중규모 ~ 대규모 네트워크에도 대응할 수 있다. |
> |   BGP(Border Gateway Protocol)    |        주로 인터넷 백본에서 이용한다.        |
>
>  <img src="https://ifh.cc/g/udhp5B.jpg" alt="l3-switch" style="zoom:30%;" />



### 경로 요약 : 방대한 경로 정보를 모아서 등록하는 방법

##### 경로를 요약해서 등록

> 라우터의 라우팅 테이블에는 전송 가능성이 있는 모든 네트워크의 경로 정보가 필요하다. 하지만 모든 네트워크의 경로 정보를 라우팅 테이블에 등록하기는 어렵다. 라우팅 동작은 이웃 라우터(넥스트 홉)까지만 보내면 되니깐 방대한 수의 경로 정보를 저장하는 것은 의미가 없다. 
>
> 그래서 <strong>경로 요약</strong>이 고안됐다. 넥스트 홉이 공통인 원격 네트워크의 경로 정보를 하나로 모서 등록할 수 있다.



### 디폴트 경로 : 경로 정보를 최대한으로 줄이는 방법

##### 모든 네트워크를 집약

> 경로 요약을 가장 극단적으로 적용한 것이 <strong>디폴트 경로</strong>이다. 디폴트 경로는 '0.0.0.0/0'으로 나타내는 경로 정보로, 모든 네트워크를 집약했다. 결국, 디폴트 경로를 라우팅 테이블에 등록해 두면, 모든 네트워크의 경로 정보를 등록한 게 된다.

##### 디폴트 경로 이용 예

> 인터넷에는 방대한 수의 네트워크가 존재하지만, 패킷을 라우팅할 때 넥스트 홉이 대부분 공통으로 되어 있다. 그래서 인터넷에 존재하는 방대한 수의 네트워크를 경로로 모두 집약해서 라우팅 테이블에 등록한다.
>
> 또한, 기업의 소규모 거점의 라우터에서는 다른 거점의 사내 네트워크와 인터넷 네트워크를 디폴트 경로로 집약하기도 한다.



###  라우터와 레이어2 스위치의 기능을 가진 데이터 전송 기기

##### 레이어3 스위치의 개요

> <strong>레이어3 </strong>는 레이어2 스위치에 라우터 기능을 추가한 네트워크 기기이다. 그 때문에 레이어2 스위치처럼 데이터 전송도 할 수 있고, 라우터처럼 데이터 전송도 할 수 있다. 레이어2 스위치처럼 많은 이더넷 인터페이스를 갖춘 네트워크 기기이다.
>
> | 특징                                  | 레이어2 스위치  |    라우터     |
> | :------------------------------------ | :-------------: | :-----------: |
> | 데이터                                |  이더넷 프레임  |    IP 패킷    |
> | 데이터 전송범위                       |  동일 네트워크  | 다른 네트워크 |
> | 전송을 위한 테이블                    | MAC 주소 테이블 | 라우팅 테이블 |
> | 전송 시 참조하는 주소                 |    MAC 주소     |    IP 주소    |
> | 테이블에 필요한 정보가 없을 때의 동작 |  데이터 플러싱  |  데이터 폐기  |



##### 레이어2 스위치로도 라우터로도 사용할 수 있다

> 레이어3 스위치는 같은 네트워크로 데이터를 전송할 때는 레이어2 스위치처럼 MAC주소를 기반으로 전송한다. 반면에, 다른 네트워크로 데이터를 전송할 때는 라우터처럼 IP 주소를 기반으로 전송한다.



### VLAN : 레이어2 스위치로 네트워크를 분할한다

##### 네트워크를 복수로 분할한다

> 레이어2 스위치는 하나의 이더넷 네트워크를 구성하는 네트워크 기기이다. 하나의 네트워크에 수많은 기기를 연결하면 불필요한 데이터 전송이 많이 발생하게 된다. 불필요한 데이터 전송을 억제하고, 보안이나 관리면에서 네트워크를 분할할 필요가 있다.
>
> 레이어2 스위치는 보통은 '하나'의 네트워크를 구성하지만, 레이어2 스위치에서 네트워크를 복수로 분할할 수 있게 하는 것이  <strong>VLAN</strong>이다.

##### VLAN의 동작 원리

> 일반 레이어2 스위치는 모든 포트 사이에서 이더넷 프레임을 전송할 수 있다. 그것을 VLAN으로 나누어 '같은 VLAN에 할당한 포트끼리만 이더넷 프레임을 전송'하도록 한다.



### VLAN 이용의 장점 : VLAN을 사용하는 이유

##### VLAN은 레이어2 스위치를 분할한다

> VLAN은 레이어2 스위치를 가상으로 분할하는 것이다. 분할한 VLAN의 스위치가 될 포트는 설정하기 나름으로 자유롭게 결정할 수 있다.
>
> 또한, VLAN별 스위치 사이는 연결되어 있지 않으므로, 네트워크를 분할하여 VLAN 간의 데이터를 분리한다. 즉 데이터가 전송되는 범위를 제한할 수 있다.



##### VLAN은 네트워크를 분할할 뿐이다

> VLAN으로 분할한 네트워크가 서로 통신하기 위해서는 라투어와 레이어3 스위치가 필요하다.  라우터 또는 레이어3 스위치를 이용하여 VLAN으로 분할한 네트워크를 서로 연결한다. VLAN끼리 연결해서 서로 통신할 수 있게 하는 것을 VLAN 간 라우팅이라고 부른다.



### 태그 VLAN, IEEE802.1Q : 복수의 접속선을 한 줄로 깔끔하게 정리한다

##### 복수의 스위치로 VLAN을 만든다

> VLAN은 1대뿐만 아니라 복수의 스위치에 걸쳐서 만들 수도 있다. 단, VLAN의 동작 원리상 복수의 스위치로 VLAN을 만들 때에는 스위치 간의 연결이 VLAN마다 필요하다. VLAN이 두 개 있으면, 스위치 사이를 두 줄로 연결해야만 한다.
>
> 스위치 사이를 효율적으로 연결하기 위해서 <strong>태그 VLAN</strong>('트렁크' 라고도 부른다.) 포트가 있다.

##### 태그 VLAN

> 태그 VLAN 포트를 이용해 복수의 레이어2 스위치로 VLAN을 구성할 때, 레이어2 스위치 간의 접속을 한 줄로 해결할 수 있다.
>
> 태그 VLAN 포트는 복수의 VLAN에 할당되어, 복수의 VLAN 이더넷 프레임을 전송할 수 있는 포트이다.
>
> 태그 VLAN 포트로 송수신하는 이더넷 프레임에는 <strong>VLAN 태그</strong>가 추가된다. VLAN 태그로 스위치 사이에 전송되는 이더넷 프레임이 원래 어느 VLAN의 이더넷 프레임인지 알 수 있다.
>
> VLAN 태그는 <strong>IEEE802.1Q</strong>로 규정되어 있다. 태그 VLAN 포트에서 다루는 이더넷 프레임에는 헤더 부분에 VLAN 태그가 추가되어 VLAN을 식별할 수 있게했다.



### VLAN과 태그 VLAN : 기기 추가나 배선을 변경하지 않고 네트워크를 바꾼다

##### 포트는 하나라도

> 태그 VLAN 포트를 이해하기 쉽게 생각하면, '할당한 VLAN 별로 분할할 수 있는 포트'이다.



##### VLAN은 스위치를 분할, 태그 VLAN은 포트를 분할

> - VLAN : 레이어2 스위치를 가상으로 분할
> - 태그 VLAN : 포트를 VLAN별로 가상으로 분할



##### 설정으로 자유롭게 결정할 수 있다

> 레이어2 스위치에서 만든 VLAN은 설정으로 자유롭게 결정할 수 있다. 또한, 어느 포트를 어느 VLAN에 할당할지와 태그 VLAN 포트 등도 설정으로 자유롭게 결정할 수 있다. 
>
> VLAN과 관련 포트 설저에 따라, 기기 추가나 배선 변경 등을 하지 않고도 네트워크를 몇 개로 할지 자유롭게 결정할 수 있다. 즉, VLAN을 이용하면 네트워크를  유연하게 구성할 수 있다는 장점이 있다.



### VLAN 간 라우팅 : 분할한 네트워크끼리 연결하는 방법

##### VLAN은 네트워크를 나누기만 한다

> 레이어2 스위치의 VLAN은 '네트워크를 분할하기만 할 뿐'이다. VLAN 간 통신을 위해서는 VLAN을 서로 연결해야 한다. VLAN을 서로 연결해서 VLAN끼리 통신할 수 있게 하는 것을 <strong>VLAN 간 라우팅</strong>이라고 부른다.
>
> VLAN 간 라우팅을 실현 하려면, 라우터 또는 레이어3 스위치가 필요하다. 덧붙여, 라우터보다는 레이어3 스위치를 이용하는 편이 효율적으로 VLAN 간 라우팅을 할 수 있다.



##### IP 주소를 설정하면 네트워크(VLAN)를 연결한다

> 애초에 IP주소를 설정해야 네트워크(VLAN)가 연결된다.
>
> 레이어3 스위치로 네트워크(VLAN)를 연결하려면, 레이어3 스위치에 IP 주소를 설정해야 한다. 
>
> - 레이어3 스위치 내부의 가상 인터페이스(VLAN 인터페이스)에 IP 주소를 설정한다
> - 레이어3 스위치의 포트 자체에 IP 주소를 설정한다



### 기본 게이트웨이 : PC에도 라우팅 테이블이 있다

##### 라우터와 레이어3 스위치뿐만이 아니다

> PC나 서버 등 TCP/IP를 이용하는 모든 기기에는 라우팅 테이블이 있고, 라우팅 테이블에 따라 라우팅한다.



##### 모르는 네트워크는 보낼 수 없다

> PC에서도 라우팅 테이블에 기재되지 않은 네트워크로는 IP 패킷을 보낼 수 없다. PC의 라우팅 테이블에 IP 패킷을 전송하고 싶은 모든 네트워크를 등록해 두어야 한다.



##### 디폴트 경로로 모아서 등록

> PC의 라우팅 테이블에는 너무 자세히 경로 정보를 등록하지 않는다. 
>
> 등록할 경로 정보는 기본적으로 다음 두 가지이다.
>
> - 직접 접속 경로 정보 : IP 주소 설정
> - 디폴트 경로 : 기본 게이트웨이의 IP 주소 설정
>
> IP 주소를 설정함으로써, PC가 직접 접속된 네트워크의 경로 정보가 라우팅 테이블에 등록된다. 
>
> 그리고 PC 자신이 연결되어 있는 네트워크 이외는 전부 '0.0.0.0/0'인 디폴트 경로로 모아서 등록한다. 그 설정이 <strong>기본 게이트웨이</strong>의 IP 주소 설정이다.



























